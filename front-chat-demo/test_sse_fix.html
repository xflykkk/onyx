<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SSE ä¿®å¤æµ‹è¯•</title>
  <style>
    body { 
      font-family: monospace; 
      padding: 20px; 
      background: #1a1a1a; 
      color: #00ff00; 
    }
    .test-area { 
      background: #2a2a2a; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 5px; 
      border: 1px solid #444; 
    }
    button { 
      background: #4CAF50; 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      margin: 5px; 
    }
    button:hover { background: #45a049; }
    .output { 
      white-space: pre-wrap; 
      max-height: 300px; 
      overflow-y: auto; 
      background: #000; 
      padding: 10px; 
      border-radius: 3px; 
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ SSE è§£æå™¨ä¿®å¤æµ‹è¯•</h1>
  
  <div class="test-area">
    <h3>ğŸ“‹ æµ‹è¯•åœºæ™¯ï¼š</h3>
    <p>1. æ ‡å‡†SSEæ ¼å¼ (data: å‰ç¼€)</p>
    <p>2. ç›´æ¥JSONæ ¼å¼ (Onyxåç«¯å®é™…æ ¼å¼)</p>
    <p>3. æ··åˆæ ¼å¼</p>
    <button onclick="runTests()">â–¶ï¸ è¿è¡Œæµ‹è¯•</button>
    <button onclick="clearOutput()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å‡º</button>
  </div>

  <div class="test-area">
    <h3>ğŸ“Š æµ‹è¯•ç»“æœï¼š</h3>
    <div id="output" class="output"></div>
  </div>

  <script>
    // æ¨¡æ‹Ÿä¿®å¤åçš„SSEè§£æå™¨
    class SSEParserTest {
      constructor() {
        this.buffer = '';
      }
      
      parseChunk(chunk) {
        this.buffer += chunk;
        const lines = this.buffer.split('\n');
        
        // Keep the last (potentially incomplete) line in the buffer
        this.buffer = lines.pop() || '';
        
        const events = [];
        
        for (const line of lines) {
          const trimmedLine = line.trim();
          
          // Skip empty lines
          if (!trimmedLine) {
            continue;
          }
          
          // Handle standard SSE format with "data: " prefix
          if (line.startsWith('data: ')) {
            const data = line.slice(6); // Remove 'data: ' prefix
            if (data.trim() && data !== '[DONE]') {
              events.push(data);
            }
          }
          // Handle direct JSON format (what Onyx backend actually sends)
          else if (trimmedLine.startsWith('{') && trimmedLine.endsWith('}')) {
            try {
              // Validate it's proper JSON by attempting to parse
              JSON.parse(trimmedLine);
              events.push(trimmedLine);
            } catch (error) {
              console.warn('Failed to parse JSON line:', trimmedLine, error);
            }
          }
          // Handle other SSE event types if needed
          else if (line.startsWith('event: ') || line.startsWith('id: ') || line.startsWith('retry: ')) {
            // These are SSE metadata lines, skip them for now
            continue;
          }
          else {
            // Log unexpected formats for debugging
            console.warn('Unexpected SSE line format:', line);
          }
        }
        
        return events;
      }
      
      reset() {
        this.buffer = '';
      }
    }

    function log(message) {
      const output = document.getElementById('output');
      output.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
      output.scrollTop = output.scrollHeight;
    }

    function clearOutput() {
      document.getElementById('output').textContent = '';
    }

    function runTests() {
      clearOutput();
      log('ğŸš€ å¼€å§‹SSEè§£æå™¨æµ‹è¯•...\n');

      const parser = new SSEParserTest();

      // æµ‹è¯•1: æ ‡å‡†SSEæ ¼å¼
      log('ğŸ“ æµ‹è¯•1: æ ‡å‡†SSEæ ¼å¼');
      const sseData = 'data: {"answer_piece": "Hello"}\ndata: {"answer_piece": " world"}\n\n';
      const sseResults = parser.parseChunk(sseData);
      log(`   è¾“å…¥: ${JSON.stringify(sseData)}`);
      log(`   è§£æç»“æœ: ${JSON.stringify(sseResults)}`);
      log(`   âœ… æœŸæœ›: 2ä¸ªäº‹ä»¶, å®é™…: ${sseResults.length}ä¸ªäº‹ä»¶\n`);

      parser.reset();

      // æµ‹è¯•2: ç›´æ¥JSONæ ¼å¼ (Onyxåç«¯æ ¼å¼)
      log('ğŸ“ æµ‹è¯•2: ç›´æ¥JSONæ ¼å¼ (Onyxåç«¯å®é™…æ ¼å¼)');
      const jsonData = '{"answer_piece": "Hello"}\n{"answer_piece": " world"}\n{"message_id": 123}\n';
      const jsonResults = parser.parseChunk(jsonData);
      log(`   è¾“å…¥: ${JSON.stringify(jsonData)}`);
      log(`   è§£æç»“æœ: ${JSON.stringify(jsonResults)}`);
      log(`   âœ… æœŸæœ›: 3ä¸ªäº‹ä»¶, å®é™…: ${jsonResults.length}ä¸ªäº‹ä»¶\n`);

      parser.reset();

      // æµ‹è¯•3: æ··åˆæ ¼å¼
      log('ğŸ“ æµ‹è¯•3: æ··åˆæ ¼å¼');
      const mixedData = 'data: {"answer_piece": "SSE "}\n{"answer_piece": "JSON "}\nevent: test\ndata: {"answer_piece": "mixed"}\n';
      const mixedResults = parser.parseChunk(mixedData);
      log(`   è¾“å…¥: ${JSON.stringify(mixedData)}`);
      log(`   è§£æç»“æœ: ${JSON.stringify(mixedResults)}`);
      log(`   âœ… æœŸæœ›: 3ä¸ªäº‹ä»¶, å®é™…: ${mixedResults.length}ä¸ªäº‹ä»¶\n`);

      parser.reset();

      // æµ‹è¯•4: åˆ†å—æ¥æ”¶ (æ¨¡æ‹Ÿç½‘ç»œæµ)
      log('ğŸ“ æµ‹è¯•4: åˆ†å—æ¥æ”¶æ¨¡æ‹Ÿ');
      const chunk1 = '{"answer_piece": "Hel';
      const chunk2 = 'lo"}\n{"answer_piece": " wor';
      const chunk3 = 'ld"}\n';
      
      const result1 = parser.parseChunk(chunk1);
      const result2 = parser.parseChunk(chunk2);
      const result3 = parser.parseChunk(chunk3);
      
      log(`   åˆ†å—1: ${JSON.stringify(chunk1)} -> ${result1.length}ä¸ªäº‹ä»¶`);
      log(`   åˆ†å—2: ${JSON.stringify(chunk2)} -> ${result2.length}ä¸ªäº‹ä»¶`);
      log(`   åˆ†å—3: ${JSON.stringify(chunk3)} -> ${result3.length}ä¸ªäº‹ä»¶`);
      log(`   âœ… æ€»äº‹ä»¶æ•°: ${result1.length + result2.length + result3.length}\n`);

      // æµ‹è¯•5: é”™è¯¯å¤„ç†
      log('ğŸ“ æµ‹è¯•5: é”™è¯¯å¤„ç†');
      const invalidData = '{"invalid": json}\n{"answer_piece": "valid"}\n';
      const errorResults = parser.parseChunk(invalidData);
      log(`   è¾“å…¥: ${JSON.stringify(invalidData)}`);
      log(`   è§£æç»“æœ: ${JSON.stringify(errorResults)}`);
      log(`   âœ… æœŸæœ›: 1ä¸ªæœ‰æ•ˆäº‹ä»¶, å®é™…: ${errorResults.length}ä¸ªäº‹ä»¶\n`);

      log('ğŸ‰ æµ‹è¯•å®Œæˆ! å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½æ˜¾ç¤ºæ­£ç¡®çš„äº‹ä»¶æ•°é‡ï¼Œè¯´æ˜SSEè§£æå™¨ä¿®å¤æˆåŠŸï¼');
    }
  </script>
</body>
</html> 