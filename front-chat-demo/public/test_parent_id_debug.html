<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parent Message ID è°ƒè¯•æµ‹è¯•</title>
  <style>
    body { 
      font-family: monospace; 
      padding: 20px; 
      background: #1a1a1a; 
      color: #00ff00; 
    }
    .test-area { 
      background: #2a2a2a; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 5px; 
      border: 1px solid #444; 
    }
    button { 
      background: #4CAF50; 
      color: white; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      margin: 5px; 
    }
    button:hover { background: #45a049; }
    .output { 
      white-space: pre-wrap; 
      max-height: 400px; 
      overflow-y: auto; 
      background: #000; 
      padding: 10px; 
      border-radius: 5px; 
      border: 1px solid #444; 
      margin-top: 10px; 
    }
    .error { color: #ff4444; }
    .success { color: #44ff44; }
    .info { color: #4444ff; }
  </style>
</head>
<body>
  <h1>ğŸ”§ Parent Message ID è°ƒè¯•æµ‹è¯•</h1>
  <p>æµ‹è¯•ç¬¬äºŒæ¬¡èŠå¤©æ—¶parent_message_idçš„é—®é¢˜</p>
  
  <div class="test-area">
    <h3>APIç«¯ç‚¹æµ‹è¯•</h3>
    <button onclick="testCreateSession()">1ï¸âƒ£ åˆ›å»ºChat Session</button>
    <button onclick="testFirstMessage()" id="firstMsgBtn" disabled>2ï¸âƒ£ å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯</button>
    <button onclick="testSecondMessage()" id="secondMsgBtn" disabled>3ï¸âƒ£ å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯</button>
    <div id="output" class="output"></div>
  </div>

  <script>
    const API_BASE = 'http://172.16.3.94:8888';
    let chatSessionId = null;
    let parentMessageId = null;
    let messageCount = 0;

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    async function testCreateSession() {
      log('ğŸš€ åˆ›å»ºChat Session...');
      
      try {
        const response = await fetch(`${API_BASE}/chat/create-chat-session`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            persona_id: 0
          })
        });

        if (response.ok) {
        const data = await response.json();
        chatSessionId = data.chat_session_id;
        log(`âœ… Sessionåˆ›å»ºæˆåŠŸ: ${chatSessionId}`, 'success');
          document.getElementById('firstMsgBtn').disabled = false;
        } else {
          const errorText = await response.text();
          log(`âŒ Sessionåˆ›å»ºå¤±è´¥: HTTP ${response.status}: ${errorText}`, 'error');
        }
      } catch (error) {
        log(`âŒ Sessionåˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testFirstMessage() {
      if (!chatSessionId) {
        log('âŒ è¯·å…ˆåˆ›å»ºChat Session', 'error');
        return;
      }

      log('ğŸ“¤ å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯...');
      messageCount++;
      
      try {
        const response = await fetch(`${API_BASE}/chat/send-message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_session_id: chatSessionId,
            parent_message_id: parentMessageId, // ç¬¬ä¸€æ¬¡åº”è¯¥æ˜¯null
            message: `æµ‹è¯•æ¶ˆæ¯ #${messageCount}`,
            file_descriptors: [],
            prompt_id: null,
            search_doc_ids: null,
            retrieval_options: {
              run_search: "always",
              real_time: true,
              enable_auto_detect_filters: false,
              filters: {}
            }
          })
        });

        if (response.ok) {
          log(`âœ… ç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€æˆåŠŸ`, 'success');
          log(`ğŸ”„ å¼€å§‹ç›‘å¬SSEæµ...`, 'info');
          
          // è¯»å–SSEæµ
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
              if (line.trim()) {
                try {
                  const data = JSON.parse(line);
                  
                  // æ£€æŸ¥æ˜¯å¦æ˜¯ChatMessageDetailPacket
                  if (data.message_id) {
                    parentMessageId = data.message_id;
                    log(`ğŸ†” æ”¶åˆ°message_id: ${parentMessageId}`, 'success');
                    document.getElementById('secondMsgBtn').disabled = false;
                  }
                  
                  if (data.answer_piece) {
                    log(`ğŸ’¬ æ”¶åˆ°å›ç­”ç‰‡æ®µ: ${data.answer_piece}`);
                  }
                } catch (e) {
                  // å¿½ç•¥éJSONè¡Œ
                }
              }
            }
        }

          log(`âœ… ç¬¬ä¸€æ¡æ¶ˆæ¯å¤„ç†å®Œæˆ`, 'success');
        } else {
          const errorText = await response.text();
          log(`âŒ ç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€å¤±è´¥: HTTP ${response.status}: ${errorText}`, 'error');
        }
      } catch (error) {
        log(`âŒ ç¬¬ä¸€æ¡æ¶ˆæ¯å‘é€å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testSecondMessage() {
      if (!chatSessionId) {
        log('âŒ è¯·å…ˆåˆ›å»ºChat Session', 'error');
        return;
      }

      if (!parentMessageId) {
        log('âŒ æ²¡æœ‰æœ‰æ•ˆçš„parent_message_idï¼Œè¯·å…ˆå‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯', 'error');
        return;
      }

      log('ğŸ“¤ å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯...');
      log(`ğŸ”— ä½¿ç”¨parent_message_id: ${parentMessageId}`, 'info');
      messageCount++;
      
      try {
        const response = await fetch(`${API_BASE}/chat/send-message`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_session_id: chatSessionId,
            parent_message_id: parentMessageId, // ä½¿ç”¨ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ID
            message: `æµ‹è¯•æ¶ˆæ¯ #${messageCount}`,
            file_descriptors: [],
            prompt_id: null,
            search_doc_ids: null,
            retrieval_options: {
              run_search: "always",
              real_time: true,
              enable_auto_detect_filters: false,
              filters: {}
        }
          })
        });

        if (response.ok) {
          log(`âœ… ç¬¬äºŒæ¡æ¶ˆæ¯å‘é€æˆåŠŸï¼é—®é¢˜å·²è§£å†³ï¼`, 'success');
          
          // ç®€å•å¤„ç†SSEæµ
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
          let receivedData = false;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

            const chunk = decoder.decode(value);
            if (chunk.trim()) {
              receivedData = true;
              log(`ğŸ“¥ æ”¶åˆ°å“åº”æ•°æ®: ${chunk.substring(0, 100)}...`);
              break; // åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªæ•°æ®åŒ…
            }
        }

          if (receivedData) {
            log(`ğŸ‰ ç¬¬äºŒæ¡æ¶ˆæ¯æµ‹è¯•é€šè¿‡ï¼parent_message_idæ­£å¸¸å·¥ä½œï¼`, 'success');
          }
        } else {
          const errorText = await response.text();
          log(`âŒ ç¬¬äºŒæ¡æ¶ˆæ¯å‘é€å¤±è´¥: HTTP ${response.status}: ${errorText}`, 'error');
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯parent_message_idé—®é¢˜
          if (errorText.includes('parent_message_id') || response.status === 500) {
            log(`ğŸ” è¿™å¯èƒ½æ˜¯parent_message_idç›¸å…³çš„é”™è¯¯`, 'error');
          }
        }
      } catch (error) {
        log(`âŒ ç¬¬äºŒæ¡æ¶ˆæ¯å‘é€å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆæ—¶çš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      log('ğŸš€ è¯·æŒ‰é¡ºåºç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...');
    });
  </script>
</body>
</html> 